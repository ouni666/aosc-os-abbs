From e891ac04e0c84917e2f326ea6f04f3b3fe468406 Mon Sep 17 00:00:00 2001
From: ouni666 <fangwenbin@vip.qq.com>
Date: Sun, 28 Sep 2025 20:18:18 +0800
Subject: [PATCH] use system dynamic link libs

---
 cmake/dependencies/common.cmake | 14 ++++++++++++--
 1 file changed, 12 insertions(+), 2 deletions(-)

diff --git a/cmake/dependencies/common.cmake b/cmake/dependencies/common.cmake
index 97319be6..ab29ad10 100644
--- a/cmake/dependencies/common.cmake
+++ b/cmake/dependencies/common.cmake
@@ -26,14 +26,23 @@ pkg_check_modules(CURL REQUIRED libcurl)
 pkg_check_modules(MINIUPNP miniupnpc REQUIRED)
 include_directories(SYSTEM ${MINIUPNP_INCLUDE_DIRS})

-# ffmpeg pre-compiled binaries
+# ffmpeg pre-compiled binaries/system libraries
 if(NOT DEFINED FFMPEG_PREPARED_BINARIES)
     if(WIN32)
         set(FFMPEG_PLATFORM_LIBRARIES mfplat ole32 strmiids mfuuid vpl)
     elseif(UNIX AND NOT APPLE)
         set(FFMPEG_PLATFORM_LIBRARIES numa va va-drm va-x11 X11)
     endif()
-    set(FFMPEG_PREPARED_BINARIES
+
+    if(FFMPEG_USE_SYSTEM_LIBRARIES)
+        set(FFMPEG_LIBRARIES
+            avcodec
+            avutil
+            swscale
+            "/usr/lib/libcbs.a"
+            ${FFMPEG_PLATFORM_LIBRARIES})
+    else()
+        set(FFMPEG_PREPARED_BINARIES
             "${CMAKE_SOURCE_DIR}/third-party/build-deps/dist/${CMAKE_SYSTEM_NAME}-${CMAKE_SYSTEM_PROCESSOR}")

     # check if the directory exists
@@ -59,6 +68,7 @@ if(NOT DEFINED FFMPEG_PREPARED_BINARIES)
             "${FFMPEG_PREPARED_BINARIES}/lib/libx265.a"
             ${HDR10_PLUS_LIBRARY}
             ${FFMPEG_PLATFORM_LIBRARIES})
+    endif()
 else()
     set(FFMPEG_LIBRARIES
         "${FFMPEG_PREPARED_BINARIES}/lib/libavcodec.a"
--
2.51.0
