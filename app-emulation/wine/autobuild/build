abinfo "Applying Wine Staging patches ..."
ln -sv "$SRCDIR" \
    "$SRCDIR"/../wine-staging/patches/wine
"$SRCDIR"/../wine-staging/staging/patchinstall.py \
    DESTDIR="$SRCDIR" --all

abinfo "Preparing to build main (native) Wine runtime ..."
mkdir -pv "$SRCDIR"/wine
cd "$SRCDIR"/wine
if ! ab_match_arch i486; then
     _WINE_WIN64="--enable-win64"
else
     _WINE_WIN16="--enable-win16"
fi

abinfo "Configuring main (native) Wine runtime ..."
../configure \
    --prefix=/usr \
    --libdir=/usr/lib \
    ${AUTOTOOLS_AFTER[@]} ${_WINE_WIN64} ${_WINE_WIN16}

abinfo "Building main (native) Wine runtime ..."
make

abinfo "Installing main (native) Wine runtime ..."
make install \
    prefix="$PKGDIR/usr" \
    libdir="$PKGDIR/usr/lib" \
    dlldir="$PKGDIR/usr/lib/wine" \
    -j1

if ab_match_arch amd64; then
    abinfo "Setting up multilib wrapper ..."
    export \
        CC="gcc-multilib-wrapper" \
        CXX="g++-multilib-wrapper"

    abinfo "Preparing to build 32-bit Wine runtime ..."
    mkdir -pv "$SRCDIR"/wine32
    cd "$SRCDIR"/wine32

    abinfo "Configuring 32-bit Wine runtime ..."
    ../configure \
        --prefix=/usr \
        --libdir=/usr/lib \
        --with-wine64="$SRCDIR"/wine \
        --enable-win16 \
        ${AUTOTOOLS_AFTER[@]} \
        --without-pcsclite \
        --without-sane \
        --without-gphoto \
        --without-cups \
        --without-netapi \
        PKG_CONFIG_PATH="/opt/32/lib/pkgconfig"

    abinfo "Building 32-bit Wine runtime ..."
    make

    abinfo "Installing 32-bit Wine runtime ..."
    make install \
        prefix="$PKGDIR/usr" \
        libdir="$PKGDIR/usr/lib" \
        dlldir="$PKGDIR/usr/lib/wine" \
        -j1
fi
