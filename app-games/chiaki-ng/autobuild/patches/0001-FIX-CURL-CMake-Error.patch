From 706675ca455d173834b7f468c7c5d5e3cafadec2 Mon Sep 17 00:00:00 2001
From: ouni666 <fangwenbin@vip.qq.com>
Date: Thu, 22 May 2025 16:49:00 +0800
Subject: [PATCH] FIX CURL CMake Error

---
 lib/CMakeLists.txt | 39 +++++++++++++++++++++++++++++++--------
 1 file changed, 31 insertions(+), 8 deletions(-)

diff --git a/lib/CMakeLists.txt b/lib/CMakeLists.txt
index 02c2f839..c2dcdcc9 100644
--- a/lib/CMakeLists.txt
+++ b/lib/CMakeLists.txt
@@ -149,16 +149,39 @@ find_package(PkgConfig REQUIRED)
 pkg_search_module(MINIUPNPC REQUIRED miniupnpc IMPORTED_TARGET)
 target_link_libraries(chiaki-lib PkgConfig::MINIUPNPC)

-
-if (CHIAKI_ENABLE_SWITCH_CURL)
-	target_link_libraries(chiaki-lib CURL::libcurl)
-elseif (CHIAKI_USE_SYSTEM_CURL)
-	target_link_libraries(chiaki-lib CURL::libcurl_shared)
+find_package(CURL REQUIRED)
+
+# 检查是否找到了 CURL 库
+if(CURL_FOUND)
+    # 确保使用动态库
+    set(CURL_USE_STATIC_LIBS OFF)
+
+    # 手动查找动态库
+    find_library(CURL_SHARED_LIBRARY NAMES curl)
+    if(CURL_SHARED_LIBRARY)
+        # 创建导入目标
+        add_library(CURL::libcurl_shared SHARED IMPORTED)
+        set_target_properties(CURL::libcurl_shared PROPERTIES
+            IMPORTED_LOCATION ${CURL_SHARED_LIBRARY}
+            INTERFACE_INCLUDE_DIRECTORIES ${CURL_INCLUDE_DIRS}
+        )
+    else()
+        message(FATAL_ERROR "Could not find CURL shared library.")
+    endif()
+
+    # 根据条件链接库
+    if (CHIAKI_ENABLE_SWITCH_CURL)
+        target_link_libraries(chiaki-lib CURL::libcurl)
+    elseif (CHIAKI_USE_SYSTEM_CURL)
+        target_link_libraries(chiaki-lib CURL::libcurl_shared)
+    else()
+        # 如果你确定不使用静态库，可以给出错误提示
+        message(FATAL_ERROR "Static CURL library is not supported in this configuration.")
+    endif()
 else()
-	target_link_libraries(chiaki-lib CURL::libcurl_static)
+    message(FATAL_ERROR "Could not find CURL library.")
 endif()

-
 if(CHIAKI_LIB_ENABLE_MBEDTLS)
 	if(CHIAKI_LIB_MBEDTLS_EXTERNAL_PROJECT)
 		target_link_libraries(chiaki-lib mbedtls mbedx509 mbedcrypto)
@@ -196,4 +219,4 @@ endif()
 if(CHIAKI_ENABLE_TESTS)
 	add_executable(holepunch-test include/chiaki/remote/holepunch.h src/remote/holepunch-test.c)
 	target_link_libraries(holepunch-test chiaki-lib)
-endif()
\ No newline at end of file
+endif()
--
2.49.0

